<div class="reviews-container">
  <div class="reviews-header">
    <h3>Customer Reviews</h3>
    <button
      class="btn btn-primary"
      (click)="toggleReviewForm()"
      *ngIf="isAuthenticated()">
      Write a Review
    </button>
  </div>

  <!-- Review Statistics -->
  <div class="review-stats" *ngIf="statistics">
    <div class="stats-summary">
      <div class="average-rating">
        <div class="rating-number">{{ statistics.averageRating | number:'1.1-1' }}</div>
        <div class="stars">
          <span
            *ngFor="let star of getStarArray(statistics.averageRating)"
            class="star"
            [class.active]="isStarActive(star, statistics.averageRating)">
            ★
          </span>
        </div>
        <div class="total-reviews">{{ statistics.totalReviews }} reviews</div>
      </div>
    </div>

    <div class="rating-breakdown">
      <div *ngFor="let rating of [5,4,3,2,1]" class="rating-bar">
        <span class="rating-label">{{ rating }} ★</span>
        <div class="progress-bar">
          <div
            class="progress-fill"
            [style.width.%]="getRatingPercentage(rating)">
          </div>
        </div>
        <span class="rating-count">{{ statistics.ratingDistribution[rating] || 0 }}</span>
      </div>
    </div>
  </div>

  <!-- Filters and Sorting -->
  <div class="reviews-controls">
    <div class="filters">
      <label>
        <input
          type="checkbox"
          [(ngModel)]="showVerifiedOnly"
          (change)="onFilterChange()">
        Verified reviews only
      </label>
    </div>

    <div class="sorting">
      <label>Sort by:</label>
      <select [(ngModel)]="sortBy" (change)="onSortChange()">
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
        <option value="highest">Highest Rating</option>
        <option value="lowest">Lowest Rating</option>
      </select>
    </div>
  </div>

  <!-- Write Review Form -->
  <div class="review-form" *ngIf="showReviewForm">
    <h4>Write Your Review</h4>
    <form (ngSubmit)="submitReview()">
      <div class="form-group">
        <label>Rating:</label>
        <div class="rating-input">
          <span
            *ngFor="let star of getStarArray(newReview.rating)"
            class="star selectable"
            [class.active]="isStarActive(star, newReview.rating)"
            (click)="newReview.rating = star">
            ★
          </span>
        </div>
      </div>

      <div class="form-group">
        <label for="comment">Comment:</label>
        <textarea
          id="comment"
          [(ngModel)]="newReview.comment"
          name="comment"
          rows="4"
          placeholder="Share your experience with this product..."
          required></textarea>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting">
          {{ isSubmitting ? 'Submitting...' : 'Submit Review' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="toggleReviewForm()">
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- Error Message -->
  <div class="error-message" *ngIf="errorMessage">
    {{ errorMessage }}
  </div>

  <!-- Loading State -->
  <div class="loading" *ngIf="isLoading">
    Loading reviews...
  </div>

  <!-- Reviews List -->
  <div class="reviews-list" *ngIf="!isLoading && reviews.length > 0">
    <div
      *ngFor="let review of reviews"
      class="review-item"
      [class.verified]="review.verified">

      <div class="review-header">
        <div class="user-info">
          <span class="user-name">{{ review.userName || 'Anonymous' }}</span>
          <span class="verified-badge" *ngIf="review.verified">✓ Verified Purchase</span>
        </div>
        <div class="review-date">{{ formatDate(review.createdAt) }}</div>
      </div>

      <div class="review-rating">
        <span
          *ngFor="let star of getStarArray(review.rating)"
          class="star"
          [class.active]="isStarActive(star, review.rating)">
          ★
        </span>
      </div>

      <div class="review-comment">
        {{ review.comment }}
      </div>

      <div class="review-actions" *ngIf="canEditReview(review) || canDeleteReview(review)">
        <button
          class="btn btn-sm btn-outline"
          (click)="startEditReview(review)"
          *ngIf="canEditReview(review)">
          Edit
        </button>
        <button
          class="btn btn-sm btn-danger"
          (click)="deleteReview(review)"
          *ngIf="canDeleteReview(review)">
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Review Form -->
  <div class="review-form edit-form" *ngIf="editingReview">
    <h4>Edit Your Review</h4>
    <form (ngSubmit)="updateReview()">
      <div class="form-group">
        <label>Rating:</label>
        <div class="rating-input">
          <span
            *ngFor="let star of getStarArray(editReview.rating)"
            class="star selectable"
            [class.active]="isStarActive(star, editReview.rating)"
            (click)="editReview.rating = star">
            ★
          </span>
        </div>
      </div>

      <div class="form-group">
        <label for="editComment">Comment:</label>
        <textarea
          id="editComment"
          [(ngModel)]="editReview.comment"
          name="editComment"
          rows="4"
          required></textarea>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting">
          {{ isSubmitting ? 'Updating...' : 'Update Review' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- No Reviews Message -->
  <div class="no-reviews" *ngIf="!isLoading && reviews.length === 0">
    <p>No reviews yet. Be the first to review this product!</p>
  </div>
</div>
